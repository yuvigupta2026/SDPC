<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MCQ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:"Segoe UI",sans-serif;
  background:linear-gradient(135deg,#1e1e2f,#111827);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  color:white;
}

.card{
  background:#1f2937;
  width:90%;
  max-width:800px;
  padding:30px;
  border-radius:18px;
  box-shadow:0 15px 50px rgba(0,0,0,0.6);
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
  font-size:14px;
  color:#9ca3af;
}

h2{
  text-align:center;
  margin-bottom:20px;
}

textarea{
  width:100%;
  height:180px;
  padding:15px;
  border-radius:12px;
  border:none;
  background:#111827;
  color:white;
  resize:none;
  font-size:14px;
  outline:none;
}

button{
  padding:10px;
  border:none;
  border-radius:10px;
  font-size:14px;
  cursor:pointer;
  margin-top:10px;
  transition:0.3s;
}

.primary{
  background:#4f46e5;
  color:white;
  width:100%;
}

.primary:hover{
  background:#6366f1;
}

.logout{
  background:#ef4444;
  color:white;
  padding:6px 12px;
}

.logout:hover{
  background:#dc2626;
}

.history-btn{
  background:#10b981;
  color:white;
  margin-right:10px;
}

.history-section{
  margin-top:25px;
  background:#111827;
  padding:15px;
  border-radius:12px;
  display:none;
}

.history-item{
  background:#1f2937;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
  font-size:13px;
}

.footer{
  text-align:center;
  margin-top:15px;
  font-size:12px;
  color:#6b7280;
}
</style>
</head>

<body>

<div class="card">

  <div class="top-bar">
    <div id="welcome"></div>
    <div>
      <button class="history-btn" onclick="toggleHistory()">History</button>
      <button class="logout" onclick="logout()">Logout</button>
    </div>
  </div>

  <h2>User Dashboard</h2>

  <textarea id="mcq">
What is 2+2?
4
5
6
  </textarea>

  <button class="primary" onclick="convert()">Create Google Form</button>

  <!-- History Section -->
  <div class="history-section" id="historyBox">
    <h3>Your Previous Forms</h3>
    <div id="historyList"></div>
  </div>

  <div class="footer">
    SDPC â€¢ Auto Form Generator
  </div>

</div>

<script>

/* ===============================
   CREATE FORM
================================ */
function convert(){
  const text = document.getElementById("mcq").value;

  fetch("/api/convert", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    credentials: "include",   // IMPORTANT for session
    body: JSON.stringify({ mcqText: text })
  })
  .then(res => {
    if (!res.ok) {
      throw new Error("Unauthorized or Server Error");
    }
    return res.json();
  })
  .then(data => {
    if (data.formUrl) {
      alert("Form Created Successfully!");
      loadHistory(); 
      window.open(data.formUrl, "_blank");
    } else {
      alert("Error creating form");
    }
  })
  .catch(err => {
    console.log(err);
    alert("Login expired. Please login again.");
  });
}

/* ===============================
   TOGGLE HISTORY
================================ */
function toggleHistory(){
  const box = document.getElementById("historyBox");

  if(box.style.display === "none" || box.style.display === ""){
    box.style.display = "block";
    loadHistory();
  } else {
    box.style.display = "none";
  }
}

/* ===============================
   LOAD HISTORY
================================ */
function loadHistory(){
  fetch("/api/history", {
    credentials: "include"
  })
  .then(res => res.json())
  .then(data=>{
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if(data.length === 0){
      list.innerHTML = "<p>No history found.</p>";
      return;
    }

    data.forEach(item=>{
      list.innerHTML += `
        <div class="history-item">
          <div><strong>Date:</strong> 
          ${new Date(item.createdAt).toLocaleString("en-IN")}
          </div>
          <div>
            <a href="${item.formUrl}" target="_blank" style="color:#60a5fa;">
              Open Form
            </a>
          </div>
        </div>
      `;
    });
  });
}

/* ===============================
   LOAD USER NAME
================================ */
fetch("/auth/user", { credentials: "include" })
.then(res => res.json())
.then(data=>{
  if(data.name){
    document.getElementById("welcome").innerText = "Welcome, " + data.name;
  }
});

/* ===============================
   LOGOUT
================================ */
function logout(){
  window.location.href = "/auth/logout";
}

</script>
</body>
</html>
